{% extends 'base.html' %}

{% block title %}Permissions - {{ db_name }} - SQLite Cult{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'database_list' %}">Databases</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'database_detail' db_name %}">{{ db_name }}</a>
    <span class="breadcrumb-separator">/</span>
    <span>Permissions</span>
</div>

<div class="page-header">
    <div>
        <h1 class="page-title">Manage Permissions</h1>
        <p class="page-subtitle">Control who can access {{ db_name }}</p>
    </div>
    <a href="{% url 'database_detail' db_name %}" class="btn btn-ghost">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Back to Database
    </a>
</div>

<!-- Ownership Section -->
<div class="card mb-2">
    <div class="card-header">
        <h2 class="card-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
            Database Owner
        </h2>
    </div>
    <div class="card-body">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-1">
                <div class="avatar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div>
                    <strong>{% if owner %}{{ owner.username }}{% else %}No owner (legacy database){% endif %}</strong>
                    {% if owner %}
                        {% if owner.is_superuser %}
                            <span class="badge badge-primary">Superuser</span>
                        {% elif owner.is_staff %}
                            <span class="badge badge-info">Staff</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% if is_admin or is_owner %}
            <div>
                <button class="btn btn-ghost btn-sm" onclick="openModal('transfer-ownership-modal')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 3h5v5"></path>
                        <line x1="4" y1="20" x2="21" y2="3"></line>
                        <path d="M21 16v5h-5"></path>
                        <line x1="15" y1="15" x2="21" y2="21"></line>
                    </svg>
                    Transfer Ownership
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Shared Users Section -->
<div class="card mb-2">
    <div class="card-header flex justify-between items-center">
        <h2 class="card-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Shared With
        </h2>
        <button class="btn btn-primary btn-sm" onclick="openModal('grant-permission-modal')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Share Database
        </button>
    </div>
    <div class="card-body">
        {% if permissions %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Permission Level</th>
                    <th>Granted By</th>
                    <th>Granted At</th>
                    <th style="width: 120px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for perm in permissions %}
                <tr>
                    <td>
                        <div class="flex items-center gap-1">
                            <div class="avatar avatar-sm">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <span>{{ perm.granted_to.username }}</span>
                            {% if perm.granted_to.is_superuser %}
                                <span class="badge badge-primary">Superuser</span>
                            {% elif perm.granted_to.is_staff %}
                                <span class="badge badge-info">Staff</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <form method="post" action="{% url 'update_permission' db_name perm.granted_to.id %}" class="inline-form">
                            {% csrf_token %}
                            <select name="permission_level" class="form-select form-select-sm" onchange="this.form.submit()">
                                {% for value, label in permission_choices %}
                                <option value="{{ value }}" {% if perm.permission_level == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </td>
                    <td>{{ perm.granted_by.username }}</td>
                    <td>{{ perm.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                        <form method="post" action="{% url 'revoke_permission' db_name perm.granted_to.id %}" class="inline-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to revoke access for {{ perm.granted_to.username }}?')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Revoke
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <line x1="17" y1="14" x2="23" y2="14"></line>
            </svg>
            <p>This database is not shared with anyone yet.</p>
            <button class="btn btn-primary" onclick="openModal('grant-permission-modal')">
                Share Database
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Permission Legend -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Permission Levels
        </h2>
    </div>
    <div class="card-body">
        <div class="permission-legend">
            <div class="permission-item">
                <strong class="text-info">Read Only</strong>
                <p>Can view database schema, browse tables, export data, and run SELECT queries.</p>
            </div>
            <div class="permission-item">
                <strong class="text-warning">Read & Write</strong>
                <p>All read permissions plus: create/modify/drop tables, insert/update/delete rows, run any SQL query.</p>
            </div>
            <div class="permission-item">
                <strong class="text-success">Full Access (Admin)</strong>
                <p>All write permissions plus: manage permissions, share with other users. Cannot delete database or transfer ownership.</p>
            </div>
        </div>
    </div>
</div>

<!-- Grant Permission Modal -->
<div id="grant-permission-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('grant-permission-modal')">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Share Database</h3>
            <button class="modal-close" onclick="closeModal('grant-permission-modal')">&times;</button>
        </div>
        <form method="post" action="{% url 'grant_permission' db_name %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label for="user_id" class="form-label">Select User</label>
                    <select name="user_id" id="user_id" class="form-select" required>
                        <option value="">Choose a user...</option>
                        {% for user in available_users %}
                        <option value="{{ user.id }}">
                            {{ user.username }}
                            {% if user.first_name or user.last_name %}({{ user.first_name }} {{ user.last_name }}){% endif %}
                            {% if user.is_superuser %} [Superuser]{% elif user.is_staff %} [Staff]{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    {% if not available_users %}
                    <p class="form-help text-warning">No users available to share with. All users already have access.</p>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="permission_level" class="form-label">Permission Level</label>
                    <select name="permission_level" id="permission_level" class="form-select" required>
                        {% for value, label in permission_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('grant-permission-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary" {% if not available_users %}disabled{% endif %}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Grant Access
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Transfer Ownership Modal -->
<div id="transfer-ownership-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('transfer-ownership-modal')">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Transfer Ownership</h3>
            <button class="modal-close" onclick="closeModal('transfer-ownership-modal')">&times;</button>
        </div>
        <form method="post" action="{% url 'transfer_ownership' db_name %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="alert alert-warning mb-2">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <div>
                        <strong>Warning:</strong> Transferring ownership will give another user full control over this database. 
                        You will lose owner privileges unless the new owner grants you access.
                    </div>
                </div>
                <div class="form-group">
                    <label for="new_owner_id" class="form-label">New Owner</label>
                    <select name="new_owner_id" id="new_owner_id" class="form-select" required>
                        <option value="">Choose new owner...</option>
                        {% for user in available_users %}
                        <option value="{{ user.id }}">
                            {{ user.username }}
                            {% if user.first_name or user.last_name %}({{ user.first_name }} {{ user.last_name }}){% endif %}
                            {% if user.is_superuser %} [Superuser]{% elif user.is_staff %} [Staff]{% endif %}
                        </option>
                        {% endfor %}
                        {% for perm in permissions %}
                        <option value="{{ perm.granted_to.id }}">
                            {{ perm.granted_to.username }}
                            {% if perm.granted_to.first_name or perm.granted_to.last_name %}
                                ({{ perm.granted_to.first_name }} {{ perm.granted_to.last_name }})
                            {% endif %}
                            {% if perm.granted_to.is_superuser %} [Superuser]
                            {% elif perm.granted_to.is_staff %} [Staff]
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('transfer-ownership-modal')">Cancel</button>
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to transfer ownership? This action cannot be undone.')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 3h5v5"></path>
                        <line x1="4" y1="20" x2="21" y2="3"></line>
                    </svg>
                    Transfer Ownership
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.permission-legend {
    display: grid;
    gap: 1rem;
}
.permission-item {
    padding: 1rem;
    background: var(--bg-tertiary);
    border-radius: 0.5rem;
}
.permission-item strong {
    display: block;
    margin-bottom: 0.25rem;
}
.permission-item p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.875rem;
}
.text-info { color: var(--info); }
.text-warning { color: var(--warning); }
.text-success { color: var(--success); }
.inline-form { display: inline; }
.form-select-sm { 
    padding: 0.25rem 0.5rem; 
    font-size: 0.875rem;
}
.avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
}
.avatar-sm {
    width: 24px;
    height: 24px;
}
.alert {
    padding: 1rem;
    border-radius: 0.5rem;
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
}
.alert-warning {
    background: rgba(var(--warning-rgb), 0.1);
    border: 1px solid var(--warning);
    color: var(--warning);
}
.alert svg {
    flex-shrink: 0;
    margin-top: 0.125rem;
}
</style>
{% endblock %}
