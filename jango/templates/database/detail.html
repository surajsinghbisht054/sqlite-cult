{% extends 'base.html' %}

{% block title %}{{ db_name }} - SQLite Cult{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'database_list' %}">Databases</a>
    <span class="breadcrumb-separator">/</span>
    <span>{{ db_name }}</span>
</div>

<div class="page-header">
    <div>
        <h1 class="page-title">{{ db_name }}</h1>
        <p class="page-subtitle">{{ tables|length }} table{{ tables|length|pluralize }}</p>
    </div>
    <div class="flex gap-1">
        <a href="{% url 'query_history' db_name %}" class="btn btn-ghost">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            History
        </a>
        <button class="btn btn-primary" onclick="openModal('create-table-modal')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Table
        </button>
    </div>
</div>

<!-- Tabs -->
<div class="tabs">
    <div class="tab active" onclick="showTab('tables-tab')">Tables</div>
    <div class="tab" onclick="showTab('query-tab')">SQL Query</div>
</div>

<!-- Tables Tab -->
<div id="tables-tab" class="tab-content active">
    {% if tables %}
    <div class="grid grid-2">
        {% for table in tables %}
        <div class="table-card">
            <div class="table-card-header">
                <a href="{% url 'table_detail' db_name table.name %}" class="table-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    {{ table.name }}
                </a>
                <div class="dropdown">
                    <button class="btn-icon" onclick="this.parentElement.classList.toggle('active')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="12" cy="5" r="1"></circle>
                            <circle cx="12" cy="19" r="1"></circle>
                        </svg>
                    </button>
                    <div class="dropdown-content">
                        <a href="{% url 'table_detail' db_name table.name %}" class="dropdown-item">Browse Data</a>
                        <a href="{% url 'insert_row' db_name table.name %}" class="dropdown-item">Insert Row</a>
                        <a href="{% url 'export_table' db_name table.name %}" class="dropdown-item">Export CSV</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item danger" 
                           onclick="confirmDropTable('{{ table.name }}', '{% url 'drop_table' db_name table.name %}')">
                            Drop Table
                        </a>
                    </div>
                </div>
            </div>
            <div class="table-card-body">
                <div class="table-card-meta">
                    <span>{{ table.columns|length }} column{{ table.columns|length|pluralize }}</span>
                    <span>{{ table.row_count }} row{{ table.row_count|pluralize }}</span>
                </div>
                <div class="column-list">
                    {% for col in table.columns %}
                    <span class="column-badge{% if col.5 %} pk{% endif %}">
                        {{ col.1 }}
                        <span class="type">{{ col.2 }}</span>
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <h3 class="empty-state-title">No tables yet</h3>
            <p class="empty-state-text">Create your first table to start storing data.</p>
            <button class="btn btn-primary" onclick="openModal('create-table-modal')">
                Create Table
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Query Tab -->
<div id="query-tab" class="tab-content">
    <div class="card">
        <div class="card-body">
            <div class="query-editor">
                <label class="form-label">SQL Query</label>
                <textarea id="query-input" class="form-input query-input" 
                          placeholder="Enter your SQL query here...&#10;Example: SELECT * FROM users LIMIT 10"></textarea>
                <div class="query-actions">
                    <button class="btn btn-primary" onclick="executeQuery()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Execute
                    </button>
                    <button class="btn btn-ghost" onclick="document.getElementById('query-input').value=''">Clear</button>
                </div>
            </div>
            <div id="query-result"></div>
        </div>
    </div>
</div>

<!-- Create Table Modal -->
<div id="create-table-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('create-table-modal')">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Create New Table</h3>
            <button class="modal-close" onclick="closeModal('create-table-modal')">&times;</button>
        </div>
        <form method="post" action="{% url 'create_table' db_name %}" id="create-table-form">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="table-name">Table Name</label>
                    <input type="text" name="table_name" id="table-name" class="form-input" 
                           placeholder="users" required>
                </div>

                <!-- Toggle between Visual and SQL modes -->
                <div class="toggle-group">
                    <button type="button" class="toggle-btn active" onclick="toggleMode('visual')">Visual Builder</button>
                    <button type="button" class="toggle-btn" onclick="toggleMode('sql')">SQL Mode</button>
                </div>
                
                <input type="hidden" name="use_visual" id="use-visual" value="true">

                <!-- Visual Column Builder -->
                <div id="visual-mode">
                    <label class="form-label">Columns</label>
                    <div class="column-builder" id="column-builder">
                        <div class="column-row" data-row="0">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" name="col_name[]" class="form-input" placeholder="id" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Type</label>
                                <select name="col_type[]" class="form-input">
                                    {% for value, label in column_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Constraint</label>
                                <select name="col_constraint[]" class="form-input">
                                    {% for value, label in column_constraints %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default</label>
                                <input type="text" name="col_default[]" class="form-input" placeholder="">
                            </div>
                            <button type="button" class="remove-column-btn" onclick="removeColumnRow(this)" title="Remove column">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-ghost btn-sm add-column-btn" onclick="addColumnRow()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Column
                    </button>
                </div>

                <!-- SQL Mode -->
                <div id="sql-mode" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="columns">Column Definitions (SQL)</label>
                        <textarea name="columns" id="columns" class="form-input" rows="6"
                                  placeholder="id INTEGER PRIMARY KEY AUTOINCREMENT,
name TEXT NOT NULL,
email TEXT UNIQUE,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP"></textarea>
                        <p class="help-text">Define columns using SQLite syntax. Separate each column with a comma.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('create-table-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Table</button>
            </div>
        </form>
    </div>
</div>

<!-- Drop Table Confirmation -->
<div id="drop-confirm" class="confirm-overlay" style="display: none;">
    <div class="confirm-dialog">
        <h3 class="confirm-title">Drop Table</h3>
        <p class="confirm-message">Are you sure you want to drop "<span id="drop-table-name"></span>"? All data will be lost.</p>
        <form id="drop-form" method="post">
            {% csrf_token %}
            <div class="confirm-actions">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('drop-confirm').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-danger">Drop Table</button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
const dbName = '{{ db_name }}';
let columnRowIndex = 1;

function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

function toggleMode(mode) {
    const toggleBtns = document.querySelectorAll('.toggle-btn');
    toggleBtns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (mode === 'visual') {
        document.getElementById('visual-mode').style.display = 'block';
        document.getElementById('sql-mode').style.display = 'none';
        document.getElementById('use-visual').value = 'true';
    } else {
        document.getElementById('visual-mode').style.display = 'none';
        document.getElementById('sql-mode').style.display = 'block';
        document.getElementById('use-visual').value = 'false';
    }
}

function addColumnRow() {
    const builder = document.getElementById('column-builder');
    const row = document.createElement('div');
    row.className = 'column-row';
    row.dataset.row = columnRowIndex++;
    row.innerHTML = `
        <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" name="col_name[]" class="form-input" placeholder="column_name">
        </div>
        <div class="form-group">
            <label class="form-label">Type</label>
            <select name="col_type[]" class="form-input">
                {% for value, label in column_types %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Constraint</label>
            <select name="col_constraint[]" class="form-input">
                {% for value, label in column_constraints %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Default</label>
            <input type="text" name="col_default[]" class="form-input" placeholder="">
        </div>
        <button type="button" class="remove-column-btn" onclick="removeColumnRow(this)" title="Remove column">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    `;
    builder.appendChild(row);
}

function removeColumnRow(btn) {
    const builder = document.getElementById('column-builder');
    if (builder.children.length > 1) {
        btn.closest('.column-row').remove();
    }
}

function confirmDropTable(name, url) {
    document.getElementById('drop-table-name').textContent = name;
    document.getElementById('drop-form').action = url;
    document.getElementById('drop-confirm').style.display = 'flex';
}

function executeQuery() {
    const query = document.getElementById('query-input').value.trim();
    if (!query) return;
    
    const resultDiv = document.getElementById('query-result');
    resultDiv.innerHTML = '<div class="flex items-center gap-1"><div class="spinner"></div> Executing...</div>';
    
    fetch(`/database/${dbName}/execute/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'query=' + encodeURIComponent(query)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultDiv.innerHTML = `<div class="message message-error">${data.error}</div>`;
        } else if (data.columns) {
            let html = `<div class="query-result-header">
                <span>${data.row_count} row${data.row_count !== 1 ? 's' : ''} returned</span>
            </div>`;
            html += '<div class="table-container"><table class="data-table"><thead><tr>';
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            data.rows.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    const val = row[col];
                    html += `<td>${val === null ? '<span class="null-value">NULL</span>' : val}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<div class="message message-success">${data.message}</div>`;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `<div class="message message-error">Error: ${error.message}</div>`;
    });
}
</script>
{% endblock %}
{% endblock %}
