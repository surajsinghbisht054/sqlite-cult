{% extends 'base.html' %}

{% block title %}{{ display_name }} - SQLite Cult{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'database_list' %}">Databases</a>
    <span class="breadcrumb-separator">/</span>
    <span>{{ display_name }}</span>
</div>

<div class="page-header">
    <div>
        <h1 class="page-title">{{ display_name }}</h1>
        <p class="page-subtitle">
            {{ tables|length }} table{{ tables|length|pluralize }}
            {% if is_owner %}
                <span class="badge badge-owner">Owner</span>
            {% elif is_admin %}
                <span class="badge badge-admin">Admin</span>
            {% elif not can_write %}
                <span class="badge badge-read">Read Only</span>
            {% endif %}
        </p>
    </div>
    <div class="flex gap-1">
        <a href="{% url 'query_history' db_name %}" class="btn btn-ghost">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            History
        </a>
        {% if can_manage %}
        <a href="{% url 'database_permissions' db_name %}" class="btn btn-ghost">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Permissions
        </a>
        {% endif %}
        {% if can_write %}
        <button class="btn btn-primary" onclick="openModal('create-table-modal')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Table
        </button>
        {% endif %}
    </div>
</div>

<!-- Tabs -->
<div class="tabs">
    <div class="tab active" onclick="showTab('tables-tab')">Tables</div>
    <div class="tab" onclick="showTab('query-tab')">SQL Query</div>
    {% if is_owner or is_admin %}
    <div class="tab" onclick="showTab('api-tab')">API Access</div>
    {% endif %}
</div>

{% if not is_owner and is_admin and not has_owner %}
<!-- Legacy Database Notice -->
<div class="alert alert-warning" style="margin-bottom: 1rem; padding: 1rem; background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 8px; display: flex; align-items: center; gap: 1rem;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
    </svg>
    <div style="flex: 1;">
        <strong>Legacy Database</strong>
        <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">This database was created before ownership tracking. As an administrator, you can claim ownership.</p>
    </div>
    <form method="post" action="{% url 'claim_ownership' db_name %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning">Claim Ownership</button>
    </form>
</div>
{% endif %}

<!-- Tables Tab -->
<div id="tables-tab" class="tab-content active">
    {% if tables %}
    <div class="grid grid-2">
        {% for table in tables %}
        <div class="table-card">
            <div class="table-card-header">
                <a href="{% url 'table_detail' db_name table.name %}" class="table-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    {{ table.name }}
                </a>
                <div class="dropdown">
                    <button class="btn-icon" onclick="this.parentElement.classList.toggle('active')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="12" cy="5" r="1"></circle>
                            <circle cx="12" cy="19" r="1"></circle>
                        </svg>
                    </button>
                    <div class="dropdown-content">
                        <a href="{% url 'table_detail' db_name table.name %}" class="dropdown-item">Browse Data</a>
                        <a href="{% url 'insert_row' db_name table.name %}" class="dropdown-item">Insert Row</a>
                        <a href="{% url 'export_table' db_name table.name %}" class="dropdown-item">Export CSV</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item danger" 
                           onclick="confirmDropTable('{{ table.name }}', '{% url 'drop_table' db_name table.name %}')">
                            Drop Table
                        </a>
                    </div>
                </div>
            </div>
            <div class="table-card-body">
                <div class="table-card-meta">
                    <span>{{ table.columns|length }} column{{ table.columns|length|pluralize }}</span>
                    <span>{{ table.row_count }} row{{ table.row_count|pluralize }}</span>
                </div>
                <div class="column-list">
                    {% for col in table.columns %}
                    <span class="column-badge{% if col.5 %} pk{% endif %}">
                        {{ col.1 }}
                        <span class="type">{{ col.2 }}</span>
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <h3 class="empty-state-title">No tables yet</h3>
            <p class="empty-state-text">Create your first table to start storing data.</p>
            <button class="btn btn-primary" onclick="openModal('create-table-modal')">
                Create Table
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Query Tab -->
<div id="query-tab" class="tab-content">
    <div class="card">
        <div class="card-body">
            <div class="query-editor">
                <label class="form-label">SQL Query</label>
                <textarea id="query-input" class="form-input query-input" 
                          placeholder="Enter your SQL query here...&#10;Example: SELECT * FROM users LIMIT 10"></textarea>
                <div class="query-actions">
                    <button class="btn btn-primary" onclick="executeQuery()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Execute
                    </button>
                    <button class="btn btn-ghost" onclick="document.getElementById('query-input').value=''">Clear</button>
                </div>
            </div>
            <div id="query-result"></div>
        </div>
    </div>
</div>

<!-- API Tab -->
{% if is_owner or is_admin %}
<div id="api-tab" class="tab-content">
    {% if not has_owner %}
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-body" style="text-align: center; padding: 2rem;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem; color: var(--warning);">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <h3>Ownership Required</h3>
            <p style="color: var(--text-secondary);">API access requires database ownership. Claim ownership first to enable API.</p>
            <form method="post" action="{% url 'claim_ownership' db_name %}" style="margin-top: 1rem;">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Claim Ownership</button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
            <h3>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                API Access Control
            </h3>
        </div>
        <div class="card-body">
            <p style="margin-bottom: 1rem;">Enable API access to allow external applications (like n8n, Zapier, custom scripts) to perform CRUD operations on this database.</p>
            
            <form method="post" action="{% url 'toggle_api' db_name %}" id="api-form">
                {% csrf_token %}
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" name="api_enabled" id="api-enabled-toggle" {% if api_enabled %}checked{% endif %} style="width: 20px; height: 20px;">
                        <span style="font-weight: 500;">{% if api_enabled %}API Enabled{% else %}API Disabled{% endif %}</span>
                        {% if api_enabled %}
                        <span class="badge" style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">ACTIVE</span>
                        {% endif %}
                    </label>
                </div>
                
                <div id="api-permissions-section" style="{% if not api_enabled %}display: none;{% endif %} margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.75rem;">API Permissions</h4>
                    <p style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.875rem;">
                        Select what operations the API token can perform:
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="api_read" {% if 'read' in api_permissions %}checked{% endif %} style="width: 16px; height: 16px;">
                            <span><strong>Read</strong> - GET requests</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="api_create" {% if 'create' in api_permissions %}checked{% endif %} style="width: 16px; height: 16px;">
                            <span><strong>Create</strong> - POST requests</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="api_update" {% if 'update' in api_permissions %}checked{% endif %} style="width: 16px; height: 16px;">
                            <span><strong>Update</strong> - PUT requests</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" name="api_delete" {% if 'delete' in api_permissions %}checked{% endif %} style="width: 16px; height: 16px;">
                            <span><strong>Delete</strong> - DELETE requests</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">
                    Save API Settings
                </button>
            </form>
        </div>
    </div>
            
    {% if api_enabled %}
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
            <h3>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                API Token (JWT)
            </h3>
        </div>
        <div class="card-body">
            <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                <strong>⚠️ Keep this token secret!</strong> Anyone with this token can access your database based on the permissions below.
            </p>
            <div class="input-group" style="display: flex; gap: 10px; margin-bottom: 1rem;">
                <input type="password" value="{{ api_token }}" readonly class="form-input" id="apiKey" style="flex: 1; font-family: monospace;">
                <button type="button" class="btn btn-secondary" onclick="toggleApiKeyVisibility()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="eyeIcon">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <button type="button" class="btn btn-secondary" onclick="copyToClipboard(document.getElementById('apiKey').value); showToast('API Token copied!');">Copy</button>
                <form method="post" action="{% url 'regenerate_api_key' db_name %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning" onclick="return confirm('Are you sure? All applications using the current token will stop working.')">Regenerate</button>
                </form>
            </div>
            
            <!-- API Permissions -->
            <div style="margin-top: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;">API Permissions</h4>
                <p style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.875rem;">
                    Current permissions embedded in this token:
                </p>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    {% if 'read' in api_permissions %}
                    <span class="badge" style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 4px;">Read</span>
                    {% endif %}
                    {% if 'create' in api_permissions %}
                    <span class="badge" style="background: #10b981; color: white; padding: 4px 12px; border-radius: 4px;">Create</span>
                    {% endif %}
                    {% if 'update' in api_permissions %}
                    <span class="badge" style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 4px;">Update</span>
                    {% endif %}
                    {% if 'delete' in api_permissions %}
                    <span class="badge" style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 4px;">Delete</span>
                    {% endif %}
                </div>
                <p style="margin-top: 0.75rem; color: var(--text-secondary); font-size: 0.8rem;">
                    To change permissions, disable and re-enable API access with new permissions.
                </p>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
            <h3>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                API Documentation
            </h3>
        </div>
        <div class="card-body">
            <h4 style="margin-bottom: 0.5rem;">Authentication</h4>
            <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                Include your JWT token in the <code>Authorization</code> header with the <code>Bearer</code> prefix.
            </p>
            
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-family: monospace; font-size: 0.875rem; overflow-x: auto;">
                <code>curl -H "Authorization: Bearer YOUR_JWT_TOKEN" {{ request.scheme }}://{{ request.get_host }}/api/v1/database/{{ db_name }}/tables/</code>
            </div>

            <h4 style="margin-bottom: 0.5rem;">Available Endpoints</h4>
            <table class="data-table" style="width: 100%; margin-bottom: 1.5rem;">
                <thead>
                    <tr>
                        <th>Method</th>
                        <th>Endpoint</th>
                        <th>Description</th>
                        <th>Permission</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge" style="background: #3b82f6; color: white;">GET</span></td>
                        <td><code>/api/v1/database/{{ db_name }}/tables/</code></td>
                        <td>List all tables</td>
                        <td><code>read</code></td>
                    </tr>
                    <tr>
                        <td><span class="badge" style="background: #3b82f6; color: white;">GET</span></td>
                        <td><code>/api/v1/database/{{ db_name }}/table/{table}/</code></td>
                        <td>List rows (supports <code>?limit=50&offset=0</code>)</td>
                        <td><code>read</code></td>
                    </tr>
                    <tr>
                        <td><span class="badge" style="background: #10b981; color: white;">POST</span></td>
                        <td><code>/api/v1/database/{{ db_name }}/table/{table}/</code></td>
                        <td>Create a new row</td>
                        <td><code>create</code></td>
                    </tr>
                    <tr>
                        <td><span class="badge" style="background: #3b82f6; color: white;">GET</span></td>
                        <td><code>/api/v1/database/{{ db_name }}/table/{table}/{rowid}/</code></td>
                        <td>Get a specific row</td>
                        <td><code>read</code></td>
                    </tr>
                    <tr>
                        <td><span class="badge" style="background: #f59e0b; color: white;">PUT</span></td>
                        <td><code>/api/v1/database/{{ db_name }}/table/{table}/{rowid}/</code></td>
                        <td>Update a row</td>
                        <td><code>update</code></td>
                    </tr>
                    <tr>
                        <td><span class="badge" style="background: #ef4444; color: white;">DELETE</span></td>
                        <td><code>/api/v1/database/{{ db_name }}/table/{table}/{rowid}/</code></td>
                        <td>Delete a row</td>
                        <td><code>delete</code></td>
                    </tr>
                </tbody>
            </table>

            <h4 style="margin-bottom: 0.5rem;">Examples</h4>
            
            <p style="font-weight: 500; margin-bottom: 0.25rem;">List all tables:</p>
            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
                <code>curl -X GET -H "Authorization: Bearer {{ api_token|truncatechars:20 }}..." \<br>
                &nbsp;&nbsp;{{ request.scheme }}://{{ request.get_host }}/api/v1/database/{{ db_name }}/tables/</code>
            </div>

            <p style="font-weight: 500; margin-bottom: 0.25rem;">Create a new row:</p>
            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
                <code>curl -X POST -H "Authorization: Bearer YOUR_TOKEN" \<br>
                &nbsp;&nbsp;-H "Content-Type: application/json" \<br>
                &nbsp;&nbsp;-d '{"name": "John", "email": "john@example.com"}' \<br>
                &nbsp;&nbsp;{{ request.scheme }}://{{ request.get_host }}/api/v1/database/{{ db_name }}/table/users/</code>
            </div>

            <p style="font-weight: 500; margin-bottom: 0.25rem;">Update a row:</p>
            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
                <code>curl -X PUT -H "Authorization: Bearer YOUR_TOKEN" \<br>
                &nbsp;&nbsp;-H "Content-Type: application/json" \<br>
                &nbsp;&nbsp;-d '{"email": "newemail@example.com"}' \<br>
                &nbsp;&nbsp;{{ request.scheme }}://{{ request.get_host }}/api/v1/database/{{ db_name }}/table/users/1/</code>
            </div>

            <p style="font-weight: 500; margin-bottom: 0.25rem;">Delete a row:</p>
            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
                <code>curl -X DELETE -H "Authorization: Bearer YOUR_TOKEN" \<br>
                &nbsp;&nbsp;{{ request.scheme }}://{{ request.get_host }}/api/v1/database/{{ db_name }}/table/users/1/</code>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endif %}

<!-- Create Table Modal -->
<div id="create-table-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('create-table-modal')">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Create New Table</h3>
            <button class="modal-close" onclick="closeModal('create-table-modal')">&times;</button>
        </div>
        <form method="post" action="{% url 'create_table' db_name %}" id="create-table-form">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="table-name">Table Name</label>
                    <input type="text" name="table_name" id="table-name" class="form-input" 
                           placeholder="users" required>
                </div>

                <!-- Toggle between Visual and SQL modes -->
                <div class="toggle-group">
                    <button type="button" class="toggle-btn active" onclick="toggleMode('visual')">Visual Builder</button>
                    <button type="button" class="toggle-btn" onclick="toggleMode('sql')">SQL Mode</button>
                </div>
                
                <input type="hidden" name="use_visual" id="use-visual" value="true">

                <!-- Visual Column Builder -->
                <div id="visual-mode">
                    <label class="form-label">Columns</label>
                    <div class="column-builder" id="column-builder">
                        <div class="column-row" data-row="0">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" name="col_name[]" class="form-input" placeholder="id" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Type</label>
                                <select name="col_type[]" class="form-input">
                                    {% for value, label in column_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Constraint</label>
                                <select name="col_constraint[]" class="form-input">
                                    {% for value, label in column_constraints %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default</label>
                                <input type="text" name="col_default[]" class="form-input" placeholder="">
                            </div>
                            <button type="button" class="remove-column-btn" onclick="removeColumnRow(this)" title="Remove column">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-ghost btn-sm add-column-btn" onclick="addColumnRow()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Column
                    </button>
                </div>

                <!-- SQL Mode -->
                <div id="sql-mode" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="columns">Column Definitions (SQL)</label>
                        <textarea name="columns" id="columns" class="form-input" rows="6"
                                  placeholder="id INTEGER PRIMARY KEY AUTOINCREMENT,
name TEXT NOT NULL,
email TEXT UNIQUE,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP"></textarea>
                        <p class="help-text">Define columns using SQLite syntax. Separate each column with a comma.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('create-table-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Table</button>
            </div>
        </form>
    </div>
</div>

<!-- Drop Table Confirmation -->
<div id="drop-confirm" class="confirm-overlay" style="display: none;">
    <div class="confirm-dialog">
        <h3 class="confirm-title">Drop Table</h3>
        <p class="confirm-message">Are you sure you want to drop "<span id="drop-table-name"></span>"? All data will be lost.</p>
        <form id="drop-form" method="post">
            {% csrf_token %}
            <div class="confirm-actions">
                <button type="button" class="btn btn-ghost" onclick="document.getElementById('drop-confirm').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-danger">Drop Table</button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
const dbName = '{{ db_name }}';
let columnRowIndex = 1;

function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

function toggleMode(mode) {
    const toggleBtns = document.querySelectorAll('.toggle-btn');
    toggleBtns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (mode === 'visual') {
        document.getElementById('visual-mode').style.display = 'block';
        document.getElementById('sql-mode').style.display = 'none';
        document.getElementById('use-visual').value = 'true';
    } else {
        document.getElementById('visual-mode').style.display = 'none';
        document.getElementById('sql-mode').style.display = 'block';
        document.getElementById('use-visual').value = 'false';
    }
}

function addColumnRow() {
    const builder = document.getElementById('column-builder');
    const row = document.createElement('div');
    row.className = 'column-row';
    row.dataset.row = columnRowIndex++;
    row.innerHTML = `
        <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" name="col_name[]" class="form-input" placeholder="column_name">
        </div>
        <div class="form-group">
            <label class="form-label">Type</label>
            <select name="col_type[]" class="form-input">
                {% for value, label in column_types %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Constraint</label>
            <select name="col_constraint[]" class="form-input">
                {% for value, label in column_constraints %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Default</label>
            <input type="text" name="col_default[]" class="form-input" placeholder="">
        </div>
        <button type="button" class="remove-column-btn" onclick="removeColumnRow(this)" title="Remove column">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    `;
    builder.appendChild(row);
}

function removeColumnRow(btn) {
    const builder = document.getElementById('column-builder');
    if (builder.children.length > 1) {
        btn.closest('.column-row').remove();
    }
}

function confirmDropTable(name, url) {
    document.getElementById('drop-table-name').textContent = name;
    document.getElementById('drop-form').action = url;
    document.getElementById('drop-confirm').style.display = 'flex';
}

function toggleApiKeyVisibility() {
    const input = document.getElementById('apiKey');
    const icon = document.getElementById('eyeIcon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
    } else {
        input.type = 'password';
        icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
    }
}

// Toggle API permissions section visibility
const apiEnabledToggle = document.getElementById('api-enabled-toggle');
if (apiEnabledToggle) {
    apiEnabledToggle.addEventListener('change', function() {
        const permSection = document.getElementById('api-permissions-section');
        if (permSection) {
            permSection.style.display = this.checked ? 'block' : 'none';
        }
    });
}

function executeQuery() {
    const query = document.getElementById('query-input').value.trim();
    if (!query) return;
    
    const resultDiv = document.getElementById('query-result');
    resultDiv.innerHTML = '<div class="flex items-center gap-1"><div class="spinner"></div> Executing...</div>';
    
    fetch(`/database/${dbName}/execute/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'query=' + encodeURIComponent(query)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultDiv.innerHTML = `<div class="message message-error">${data.error}</div>`;
        } else if (data.columns) {
            let html = `<div class="query-result-header">
                <span>${data.row_count} row${data.row_count !== 1 ? 's' : ''} returned</span>
            </div>`;
            html += '<div class="table-container"><table class="data-table"><thead><tr>';
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            data.rows.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    const val = row[col];
                    html += `<td>${val === null ? '<span class="null-value">NULL</span>' : val}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<div class="message message-success">${data.message}</div>`;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `<div class="message message-error">Error: ${error.message}</div>`;
    });
}
</script>
{% endblock %}
{% endblock %}
