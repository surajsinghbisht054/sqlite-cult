{% extends 'base.html' %}

{% block title %}Import Preview - {{ table_name }} - SQLite Cult{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'database_list' %}">Databases</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'database_detail' db_name %}">{{ db_name }}</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'table_detail' db_name table_name %}">{{ table_name }}</a>
    <span class="breadcrumb-separator">/</span>
    <span>Import Preview</span>
</div>

<div class="page-header">
    <div>
        <h1 class="page-title">Import Preview</h1>
        <p class="page-subtitle">Review columns before importing data into {{ table_name }}</p>
    </div>
</div>

<div class="card mb-2">
    <div class="card-header">
        <h3 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--warning-color)" stroke-width="2" style="margin-right: 0.5rem;">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            New Columns Detected
        </h3>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 1rem;">
            The import file contains <strong>{{ missing_columns|length }}</strong> column(s) that don't exist in the table:
        </p>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
            {% for col in missing_columns %}
            <span class="badge badge-warning" style="font-size: 0.875rem; padding: 0.25rem 0.5rem;">{{ col }}</span>
            {% endfor %}
        </div>
        <p class="text-muted">
            You can add these columns before importing, or skip them and import only matching columns.
        </p>
    </div>
</div>

<div class="card mb-2">
    <div class="card-header">
        <h3 class="card-title">Column Comparison</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem; text-transform: uppercase; color: var(--color-text-muted);">File Columns ({{ file_columns|length }})</h4>
                <div style="border: 1px solid var(--color-border); border-radius: 4px; max-height: 200px; overflow-y: auto;">
                    {% for col in file_columns %}
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--color-border); {% if col in missing_columns %}background: var(--color-warning-light);{% endif %}">
                        <span class="text-mono">{{ col }}</span>
                        {% if col in missing_columns %}
                        <span class="badge badge-warning" style="margin-left: 0.5rem; font-size: 0.625rem;">NEW</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div>
                <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem; text-transform: uppercase; color: var(--color-text-muted);">Table Columns ({{ table_columns|length }})</h4>
                <div style="border: 1px solid var(--color-border); border-radius: 4px; max-height: 200px; overflow-y: auto;">
                    {% for col in table_columns %}
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--color-border);">
                        <span class="text-mono">{{ col }}</span>
                    </div>
                    {% empty %}
                    <div style="padding: 0.5rem; color: var(--color-text-muted);">No columns yet</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<form method="post" action="{% url 'import_with_columns' db_name table_name %}" id="import-form">
    {% csrf_token %}
    
    <div class="card mb-2">
        <div class="card-header">
            <h3 class="card-title">Add Missing Columns</h3>
            <label class="flex items-center gap-1">
                <input type="checkbox" id="add-columns-toggle" checked onchange="toggleColumnsConfig()">
                Add columns before import
            </label>
        </div>
        <div class="card-body" id="columns-config">
            <p class="text-muted" style="margin-bottom: 1rem;">Configure the new columns that will be added to the table:</p>
            
            <div id="columns-container">
                {% for col in missing_columns %}
                <div class="column-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.75rem; background: var(--color-surface-2); border-radius: 4px;">
                    <div>
                        <label class="form-label" style="font-size: 0.75rem;">Column Name</label>
                        <input type="text" name="col_name[]" class="form-input" value="{{ col }}" readonly style="background: var(--color-surface-3);">
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.75rem;">Type</label>
                        <select name="col_type[]" class="form-input">
                            {% for value, label in column_types %}
                            <option value="{{ value }}" {% if value == 'TEXT' %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.75rem;">Constraint</label>
                        <select name="col_constraint[]" class="form-input">
                            {% for value, label in column_constraints %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.75rem;">Default Value</label>
                        <input type="text" name="col_default[]" class="form-input" placeholder="optional">
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="flex gap-1" style="justify-content: flex-end;">
        <a href="{% url 'table_detail' db_name table_name %}" class="btn btn-ghost">Cancel</a>
        <button type="submit" name="action" value="skip_columns" class="btn btn-ghost" id="skip-btn" style="display: none;">
            Import Without New Columns
        </button>
        <button type="submit" name="action" value="add_columns" class="btn btn-primary" id="add-btn">
            Add Columns & Import
        </button>
    </div>
</form>

<script>
function toggleColumnsConfig() {
    const toggle = document.getElementById('add-columns-toggle');
    const config = document.getElementById('columns-config');
    const skipBtn = document.getElementById('skip-btn');
    const addBtn = document.getElementById('add-btn');
    
    if (toggle.checked) {
        config.style.display = 'block';
        skipBtn.style.display = 'none';
        addBtn.style.display = 'inline-flex';
    } else {
        config.style.display = 'none';
        skipBtn.style.display = 'inline-flex';
        addBtn.style.display = 'none';
    }
}
</script>
{% endblock %}
