{% extends 'base.html' %}

{% block title %}{{ table_name }} - {{ display_name }} - SQLite Cult{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'database_list' %}">Databases</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'database_detail' db_name %}">{{ display_name }}</a>
    <span class="breadcrumb-separator">/</span>
    <span>{{ table_name }}</span>
</div>

<div class="page-header">
    <div>
        <h1 class="page-title">{{ table_name }}</h1>
        <p class="page-subtitle">{{ total_rows }} row{{ total_rows|pluralize }} &bull; {{ columns|length }} column{{ columns|length|pluralize }}</p>
    </div>
    <div class="flex gap-1">
        <a href="{% url 'export_table' db_name table_name %}" class="btn btn-ghost">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export CSV
        </a>
        <a href="{% url 'insert_row' db_name table_name %}" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Insert Row
        </a>
    </div>
</div>

<div class="split-layout" id="split-layout">
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Table Options</span>
            <button class="btn-icon" onclick="toggleSidebar()" title="Collapse sidebar">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="11 17 6 12 11 7"></polyline>
                    <polyline points="18 17 13 12 18 7"></polyline>
                </svg>
            </button>
        </div>
        <!-- Metadata -->
        <div class="card mb-2">
            <div class="card-header">
                <h3 class="card-title">Metadata</h3>
                <button class="btn btn-sm btn-ghost" onclick="openModal('metadata-modal')">Edit</button>
            </div>
            <div class="card-body" style="padding: 0.5rem;">
                <div class="mb-1">
                    <strong>Tags:</strong>
                    {% if table_metadata and table_metadata.tags %}
                        <div class="flex flex-wrap gap-1 mt-1">
                            {% for tag in table_metadata.tags %}
                                <span class="badge">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <span class="text-muted">No tags</span>
                    {% endif %}
                </div>
                <div>
                    <strong>Description:</strong>
                    <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.25rem;">
                        {% if table_metadata and table_metadata.description %}
                            {{ table_metadata.description }}
                        {% else %}
                            No description
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Schema -->
        <div class="card mb-2">
            <div class="card-header">
                <h3 class="card-title">Columns</h3>
                <div class="flex gap-1">
                    <button class="btn btn-sm btn-ghost" onclick="openModal('bulk-column-modal')">Manage</button>
                    <button class="btn btn-sm btn-ghost" onclick="openModal('add-column-modal')">Add</button>
                </div>
            </div>
            <div class="card-body" style="padding: 0.5rem;">
                {% for col in columns %}
                <div class="flex items-center justify-between" style="padding: 0.5rem;">
                    <div style="flex: 1;">
                        <span class="text-mono">{{ col.1 }}</span>
                        <span class="text-muted text-mono" style="font-size: 0.75rem;">{{ col.2 }}</span>
                        {% if col.5 %}<span class="badge badge-primary" style="margin-left: 0.25rem; font-size: 0.625rem;">PK</span>{% endif %}
                        {% if col.3 %}<span class="badge badge-success" style="margin-left: 0.25rem; font-size: 0.625rem;">NOT NULL</span>{% endif %}
                    </div>
                    <div class="flex gap-1">
                        <button type="button" class="btn-icon" title="Modify column type" onclick="openModifyColumnModal('{{ col.1 }}', '{{ col.2 }}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <form method="post" action="{% url 'drop_column' db_name table_name %}" 
                              onsubmit="return confirm('Drop column {{ col.1 }}?')" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="column_name" value="{{ col.1 }}">
                            <button type="submit" class="btn-icon" title="Drop column">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Indexes -->
        <div class="card mb-2">
            <div class="card-header">
                <h3 class="card-title">Indexes</h3>
                <button class="btn btn-sm btn-ghost" onclick="openModal('create-index-modal')">Add</button>
            </div>
            <div class="card-body" style="padding: 0.5rem;">
                {% if indexes %}
                {% for idx in indexes %}
                <div class="flex items-center justify-between" style="padding: 0.5rem;">
                    <span class="text-mono" style="font-size: 0.875rem;">{{ idx.1 }}</span>
                    {% if not idx.1|slice:":7" == "sqlite_" %}
                    <form method="post" action="{% url 'drop_index' db_name table_name idx.1 %}" 
                          onsubmit="return confirm('Drop index {{ idx.1 }}?')">
                        {% csrf_token %}
                        <button type="submit" class="btn-icon" title="Drop index">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted" style="padding: 0.5rem; font-size: 0.875rem;">No indexes</p>
                {% endif %}
            </div>
        </div>

        <!-- Import -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Import Data</h3>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'import_preview' db_name table_name %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <input type="file" name="file" class="form-input" accept=".csv" required>
                        <small class="text-muted" style="display: block; margin-top: 0.25rem;">New columns will be detected automatically</small>
                    </div>
                    <button type="submit" class="btn btn-ghost btn-sm" style="width: 100%;">Import</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content - Data -->
    <div class="content">
        <div class="card">
            <!-- Excel-like Spreadsheet Toolbar -->
            <div class="spreadsheet-toolbar">
                <div class="spreadsheet-toolbar-left">
                    <div class="selection-info" id="selection-info">
                        <span class="selection-badge">Select cells to edit</span>
                    </div>
                </div>
                <div class="spreadsheet-toolbar-center">
                    <button type="button" class="toolbar-btn" id="undo-btn" onclick="undoChanges()" disabled title="Undo (Ctrl+Z)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7v6h6"></path>
                            <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6.36 2.64L3 13"></path>
                        </svg>
                    </button>
                    <button type="button" class="toolbar-btn" id="redo-btn" onclick="redoChanges()" disabled title="Redo (Ctrl+Y)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 7v6h-6"></path>
                            <path d="M3 17a9 9 0 019-9 9 9 0 016.36 2.64L21 13"></path>
                        </svg>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button type="button" class="toolbar-btn" onclick="saveAllChanges()" id="save-all-btn" disabled title="Save all changes">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        <span>Save All</span>
                    </button>
                    <button type="button" class="toolbar-btn" onclick="discardAllChanges()" id="discard-all-btn" disabled title="Discard all changes">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        <span>Discard</span>
                    </button>
                </div>
                <div class="spreadsheet-toolbar-right">
                    <span class="modified-count" id="modified-count"></span>
                </div>
            </div>
            
            <!-- Excel-like Spreadsheet Container -->
            <div class="spreadsheet-container" id="spreadsheet-container">
                <table class="spreadsheet" id="spreadsheet">
                    <!-- Header Row -->
                    <thead>
                        <tr class="spreadsheet-header">
                            <th class="spreadsheet-cell header-cell corner-cell" data-col="-1">
                                <input type="checkbox" id="select-all-rows" onchange="toggleSelectAllRows(this)" title="Select all rows">
                            </th>
                            <th class="spreadsheet-cell header-cell row-number-header" data-col="0">
                                #
                            </th>
                            {% for col in column_names %}
                            <th class="spreadsheet-cell header-cell" data-col="{{ forloop.counter }}" data-col-name="{{ col }}">
                                <div class="header-content">
                                    <span class="header-text">{{ col }}</span>
                                </div>
                                <div class="col-resize-handle" onmousedown="initColumnResize(event, {{ forloop.counter }})"></div>
                            </th>
                            {% endfor %}
                            <th class="spreadsheet-cell header-cell actions-header">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    
                    <!-- Data Rows -->
                    <tbody class="spreadsheet-body" id="spreadsheet-body">
                        {% for row in rows %}
                        <tr class="spreadsheet-row" data-rowid="{{ row.0 }}">
                            <td class="spreadsheet-cell select-cell" data-col="-1">
                                <input type="checkbox" class="row-checkbox" onchange="toggleRowSelection(this, {{ row.0 }})">
                            </td>
                            <td class="spreadsheet-cell row-number-cell" data-col="0">
                                {{ row.0 }}
                            </td>
                            {% for val in row|slice:"1:" %}
                            <td class="spreadsheet-cell data-cell" 
                                 data-col="{{ forloop.counter }}" 
                                 data-col-index="{{ forloop.counter0 }}"
                                 data-original-value="{% if val is None %}{% else %}{{ val }}{% endif %}"
                                 tabindex="0"
                                 onclick="selectCell(this)"
                                 ondblclick="editCell(this)">
                                <div class="cell-content" contenteditable="false">{% if val is None %}<span class="null-value">NULL</span>{% else %}{{ val }}{% endif %}</div>
                            </td>
                            {% endfor %}
                            <td class="spreadsheet-cell actions-cell" data-col="actions">
                                <div class="row-actions">
                                    <button type="button" class="action-btn save-btn" onclick="saveRow({{ row.0 }})" title="Save changes" style="display: none;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </button>
                                    <button type="button" class="action-btn reset-btn" onclick="resetRow({{ row.0 }})" title="Reset changes" style="display: none;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                            <path d="M3 3v5h5"></path>
                                        </svg>
                                    </button>
                                    <form method="post" action="{% url 'delete_row' db_name table_name row.0 %}"
                                          style="display: inline;" onsubmit="return confirm('Delete this row?')">
                                        {% csrf_token %}
                                        <button type="submit" class="action-btn delete-btn" title="Delete row">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr class="spreadsheet-row empty-row">
                            <td class="spreadsheet-cell" colspan="{{ column_names|length|add:3 }}">
                                No data in this table
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if total_pages > 1 %}
            <div class="pagination">
                {% if page > 1 %}
                <a href="?page={{ page|add:-1 }}&per_page={{ per_page }}" class="pagination-btn">&laquo; Previous</a>
                {% else %}
                <button class="pagination-btn" disabled>&laquo; Previous</button>
                {% endif %}
                
                <span class="pagination-info">Page {{ page }} of {{ total_pages }}</span>
                
                {% if page < total_pages %}
                <a href="?page={{ page|add:1 }}&per_page={{ per_page }}" class="pagination-btn">Next &raquo;</a>
                {% else %}
                <button class="pagination-btn" disabled>Next &raquo;</button>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- SQL Query Section -->
        <div class="card" style="margin-top: 1rem;">
            <div class="card-header" style="cursor: pointer;" onclick="toggleQuerySection()">
                <h3 class="card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.5rem;">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <path d="M12 18v-6"></path>
                        <path d="M9 15l3 3 3-3"></path>
                    </svg>
                    Execute SQL Query
                </h3>
                <svg id="query-section-toggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            <div id="query-section" class="card-body" style="display: none;">
                <div class="query-editor">
                    <div class="form-group">
                        <label class="form-label">SQL Query</label>
                        <textarea id="query-input" class="form-input query-input" rows="4"
                                  placeholder="Enter your SQL query here...&#10;Example: SELECT * FROM {{ table_name }} WHERE id = 1&#10;&#10;Tip: Use Ctrl+Enter to execute"></textarea>
                    </div>
                    <div class="query-templates" style="margin-bottom: 1rem;">
                        <span class="text-muted" style="font-size: 0.75rem; margin-right: 0.5rem;">Quick templates:</span>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="setQueryTemplate('select')">SELECT</button>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="setQueryTemplate('select_where')">SELECT WHERE</button>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="setQueryTemplate('update')">UPDATE</button>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="setQueryTemplate('delete')">DELETE</button>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="setQueryTemplate('insert')">INSERT</button>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="setQueryTemplate('count')">COUNT</button>
                    </div>
                    <div class="query-actions" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="executeQuery()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            Execute (Ctrl+Enter)
                        </button>
                        <button class="btn btn-ghost" onclick="document.getElementById('query-input').value=''">Clear</button>
                    </div>
                </div>
                <div id="query-result" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add Column Modal -->
<div id="add-column-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('add-column-modal')">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Add Column</h3>
            <button class="modal-close" onclick="closeModal('add-column-modal')">&times;</button>
        </div>
        <form method="post" action="{% url 'add_column' db_name table_name %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Column Name</label>
                    <input type="text" name="column_name" class="form-input" placeholder="new_column" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Column Type</label>
                    <select name="column_type" class="form-input">
                        {% for value, label in column_types %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Constraint</label>
                    <select name="column_constraint" class="form-input">
                        {% for value, label in column_constraints %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Default Value (optional)</label>
                    <input type="text" name="default_value" class="form-input" placeholder="Leave empty for none">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('add-column-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Column</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Index Modal -->
<div id="create-index-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('create-index-modal')">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Create Index</h3>
            <button class="modal-close" onclick="closeModal('create-index-modal')">&times;</button>
        </div>
        <form method="post" action="{% url 'create_index' db_name table_name %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Index Name</label>
                    <input type="text" name="index_name" class="form-input" required 
                           placeholder="idx_{{ table_name }}_column">
                </div>
                <div class="form-group">
                    <label class="form-label">Select Columns</label>
                    <div class="checkbox-group">
                        {% for col in column_names %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="index_columns" value="{{ col }}" class="form-checkbox">
                            <span class="text-mono">{{ col }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <small class="text-muted mt-1" style="display: block;">Select one or more columns for the index</small>
                </div>
                <div class="form-group">
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="unique" class="form-checkbox">
                        Unique index
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('create-index-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Index</button>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Column Management Modal -->
<div id="bulk-column-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('bulk-column-modal')">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Manage Columns</h3>
            <button class="modal-close" onclick="closeModal('bulk-column-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Tabs -->
            <div class="tabs" style="margin-bottom: 1rem;">
                <button type="button" class="tab active" onclick="switchBulkTab('add')" id="tab-add">Add Columns</button>
                <button type="button" class="tab" onclick="switchBulkTab('drop')" id="tab-drop">Drop Columns</button>
            </div>
            
            <!-- Add Columns Tab -->
            <div id="bulk-add-tab">
                <form method="post" action="{% url 'bulk_add_columns' db_name table_name %}" id="bulk-add-form">
                    {% csrf_token %}
                    <div id="bulk-columns-container">
                        <div class="bulk-column-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end;">
                            <div>
                                <label class="form-label" style="font-size: 0.75rem;">Name</label>
                                <input type="text" name="col_name[]" class="form-input" placeholder="column_name" required>
                            </div>
                            <div>
                                <label class="form-label" style="font-size: 0.75rem;">Type</label>
                                <select name="col_type[]" class="form-input">
                                    {% for value, label in column_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="form-label" style="font-size: 0.75rem;">Constraint</label>
                                <select name="col_constraint[]" class="form-input">
                                    {% for value, label in column_constraints %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="form-label" style="font-size: 0.75rem;">Default</label>
                                <input type="text" name="col_default[]" class="form-input" placeholder="optional">
                            </div>
                            <button type="button" class="btn-icon" onclick="removeBulkColumnRow(this)" title="Remove" style="margin-bottom: 0.25rem;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-ghost btn-sm" onclick="addBulkColumnRow()" style="margin-top: 0.5rem;">
                        + Add Another Column
                    </button>
                    <div class="modal-footer" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                        <button type="button" class="btn btn-ghost" onclick="closeModal('bulk-column-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add All Columns</button>
                    </div>
                </form>
            </div>
            
            <!-- Drop Columns Tab -->
            <div id="bulk-drop-tab" style="display: none;">
                <form method="post" action="{% url 'bulk_drop_columns' db_name table_name %}" onsubmit="return confirm('Are you sure you want to drop the selected columns? This action cannot be undone.')">
                    {% csrf_token %}
                    <p class="text-muted" style="margin-bottom: 1rem;">Select columns to drop from the table:</p>
                    <div class="checkbox-group">
                        {% for col in columns %}
                        <label class="checkbox-label" style="display: flex; align-items: center; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 4px; margin-bottom: 0.5rem;">
                            <input type="checkbox" name="columns[]" value="{{ col.1 }}" class="form-checkbox" {% if col.5 %}disabled{% endif %}>
                            <span class="text-mono" style="margin-left: 0.5rem;">{{ col.1 }}</span>
                            <span class="text-muted text-mono" style="font-size: 0.75rem; margin-left: 0.5rem;">{{ col.2 }}</span>
                            {% if col.5 %}<span class="badge badge-primary" style="margin-left: 0.5rem; font-size: 0.625rem;">PK - Cannot drop</span>{% endif %}
                        </label>
                        {% endfor %}
                    </div>
                    <div class="modal-footer" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                        <button type="button" class="btn btn-ghost" onclick="closeModal('bulk-column-modal')">Cancel</button>
                        <button type="submit" class="btn btn-danger">Drop Selected Columns</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modify Column Type Modal -->
<div id="modify-column-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('modify-column-modal')">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Modify Column Type</h3>
            <button class="modal-close" onclick="closeModal('modify-column-modal')">&times;</button>
        </div>
        <form id="modify-column-form" method="post" action="{% url 'modify_column' db_name table_name %}">
            {% csrf_token %}
            <input type="hidden" name="column_name" id="modify-column-name-hidden">
            <div class="modal-body">
                <div class="message message-warning" style="margin-bottom: 1rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span style="margin-left: 0.5rem;">Changing column type will recreate the table. Existing data may be affected if types are incompatible.</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Column Name</label>
                    <input type="text" id="modify-column-name" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Current Type</label>
                    <input type="text" id="modify-column-current-type" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">New Type</label>
                    <select name="new_type" id="modify-column-new-type" class="form-input" required>
                        {% for value, label in column_types %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Constraint (optional)</label>
                    <select name="new_constraint" class="form-input">
                        {% for value, label in column_constraints %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('modify-column-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Modify Column</button>
            </div>
        </form>
    </div>
</div>

<!-- Metadata Modal -->
<div id="metadata-modal" class="modal-overlay" onclick="if(event.target===this)closeModal('metadata-modal')">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Edit Table Metadata</h2>
            <button class="modal-close" onclick="closeModal('metadata-modal')">&times;</button>
        </div>
        <form method="post" action="{% url 'update_table_metadata' db_name table_name %}">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Tags (comma separated)</label>
                    <input type="text" name="tags" class="form-input" 
                           value="{% if table_metadata %}{{ table_metadata.tags|join:', ' }}{% endif %}"
                           placeholder="e.g. users, auth, core">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-input" rows="3"
                              placeholder="Describe this table...">{% if table_metadata %}{{ table_metadata.description }}{% endif %}</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closeModal('metadata-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
// Sidebar Toggle
const SIDEBAR_KEY = 'sqlitecult_sidebar_collapsed';

function toggleSidebar() {
    const layout = document.getElementById('split-layout');
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('sidebar-toggle');
    
    layout.classList.toggle('sidebar-collapsed');
    
    // Save state
    const isCollapsed = layout.classList.contains('sidebar-collapsed');
    localStorage.setItem(SIDEBAR_KEY, isCollapsed ? 'true' : 'false');
}

// Restore sidebar state on load
(function() {
    const isCollapsed = localStorage.getItem(SIDEBAR_KEY) === 'true';
    if (isCollapsed) {
        document.getElementById('split-layout').classList.add('sidebar-collapsed');
    }
})();

function switchBulkTab(tab) {
    document.getElementById('bulk-add-tab').style.display = tab === 'add' ? 'block' : 'none';
    document.getElementById('bulk-drop-tab').style.display = tab === 'drop' ? 'block' : 'none';
    document.getElementById('tab-add').classList.toggle('active', tab === 'add');
    document.getElementById('tab-drop').classList.toggle('active', tab === 'drop');
}

function addBulkColumnRow() {
    const container = document.getElementById('bulk-columns-container');
    const template = container.querySelector('.bulk-column-row').cloneNode(true);
    template.querySelectorAll('input').forEach(input => input.value = '');
    template.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
    container.appendChild(template);
}

function removeBulkColumnRow(btn) {
    const container = document.getElementById('bulk-columns-container');
    if (container.querySelectorAll('.bulk-column-row').length > 1) {
        btn.closest('.bulk-column-row').remove();
    }
}

// Modify Column Modal
function openModifyColumnModal(columnName, currentType) {
    document.getElementById('modify-column-name').value = columnName;
    document.getElementById('modify-column-name-hidden').value = columnName;
    document.getElementById('modify-column-current-type').value = currentType;
    
    // Try to select the current type in the dropdown
    const typeSelect = document.getElementById('modify-column-new-type');
    const normalizedType = currentType.toUpperCase().trim();
    for (let i = 0; i < typeSelect.options.length; i++) {
        if (typeSelect.options[i].value.toUpperCase() === normalizedType) {
            typeSelect.selectedIndex = i;
            break;
        }
    }
    
    openModal('modify-column-modal');
}

// Query Execution Variables
const dbName = '{{ db_name }}';
const tableName = '{{ table_name }}';
const csrfToken = '{{ csrf_token }}';
const columnNames = [{% for col in column_names %}'{{ col }}'{% if not forloop.last %}, {% endif %}{% endfor %}];

// Toggle query section visibility
function toggleQuerySection() {
    const section = document.getElementById('query-section');
    const toggle = document.getElementById('query-section-toggle');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        toggle.style.transform = 'rotate(180deg)';
    } else {
        section.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
    }
}

// Set query templates
function setQueryTemplate(type) {
    const input = document.getElementById('query-input');
    const cols = columnNames.join(', ');
    const placeholders = columnNames.map(() => '?').join(', ');
    const setClauses = columnNames.map(col => `${col} = ?`).join(', ');
    
    const templates = {
        'select': `SELECT * FROM ${tableName} LIMIT 100;`,
        'select_where': `SELECT * FROM ${tableName} WHERE column_name = 'value' LIMIT 100;`,
        'update': `UPDATE ${tableName} SET column_name = 'new_value' WHERE id = 1;`,
        'delete': `DELETE FROM ${tableName} WHERE id = 1;`,
        'insert': `INSERT INTO ${tableName} (${cols}) VALUES (${placeholders});`,
        'count': `SELECT COUNT(*) as total FROM ${tableName};`
    };
    
    input.value = templates[type] || '';
    input.focus();
}

// Execute SQL query
function executeQuery() {
    const query = document.getElementById('query-input').value.trim();
    if (!query) {
        showToast('Please enter a query', 'warning');
        return;
    }
    
    const resultDiv = document.getElementById('query-result');
    resultDiv.innerHTML = '<div class="flex items-center gap-1"><div class="spinner"></div> Executing...</div>';
    
    fetch(`/database/${dbName}/execute/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: 'query=' + encodeURIComponent(query)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            resultDiv.innerHTML = `<div class="message message-error" style="margin-bottom: 0;">${escapeHtml(data.error)}</div>`;
        } else if (data.columns) {
            let html = `<div class="query-result-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span class="text-muted">${data.row_count} row${data.row_count !== 1 ? 's' : ''} returned</span>
                <button class="btn btn-ghost btn-sm" onclick="copyQueryResults()">Copy Results</button>
            </div>`;
            html += '<div class="table-container" style="max-height: 400px;"><table class="data-table" id="query-results-table"><thead><tr>';
            data.columns.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead><tbody>';
            data.rows.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    const val = row[col];
                    html += `<td>${val === null ? '<span class="null-value">NULL</span>' : escapeHtml(String(val))}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<div class="message message-success" style="margin-bottom: 0;">${escapeHtml(data.message)}</div>`;
            // Reload page if data was modified (INSERT, UPDATE, DELETE)
            if (query.toUpperCase().match(/^\s*(INSERT|UPDATE|DELETE|DROP|ALTER)/)) {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `<div class="message message-error" style="margin-bottom: 0;">Error: ${escapeHtml(error.message)}</div>`;
    });
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Copy query results to clipboard
function copyQueryResults() {
    const table = document.getElementById('query-results-table');
    if (!table) return;
    
    let text = '';
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
    text += headers.join('\t') + '\n';
    
    table.querySelectorAll('tbody tr').forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
        text += cells.join('\t') + '\n';
    });
    
    navigator.clipboard.writeText(text).then(() => {
        showToast('Results copied to clipboard');
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// ============================================
// EXCEL-LIKE SPREADSHEET FUNCTIONALITY
// ============================================

// State management
let modifiedRows = new Map(); // rowid -> { colName: newValue, ... }
let selectedCells = new Set();
let selectedRows = new Set();
let currentCell = null;
let isEditing = false;
let columnWidths = {};

// Column resize state
let resizeState = {
    isResizing: false,
    startX: 0,
    startWidth: 0,
    colIndex: null
};

// ============================================
// CELL SELECTION
// ============================================

function selectCell(cell) {
    if (isEditing) return;
    
    // Clear previous selection unless shift is held
    if (!event.shiftKey && !event.ctrlKey && !event.metaKey) {
        clearSelection();
    }
    
    cell.classList.add('selected');
    selectedCells.add(cell);
    currentCell = cell;
    
    // Update selection info
    updateSelectionInfo();
}

function clearSelection() {
    document.querySelectorAll('.spreadsheet-cell.selected').forEach(cell => {
        cell.classList.remove('selected');
    });
    selectedCells.clear();
    currentCell = null;
    updateSelectionInfo();
}

function updateSelectionInfo() {
    const info = document.getElementById('selection-info');
    if (selectedCells.size === 0) {
        info.innerHTML = '<span class="selection-badge">Click cell to select, double-click to edit</span>';
    } else if (selectedCells.size === 1) {
        const cell = Array.from(selectedCells)[0];
        const colIndex = cell.dataset.colIndex;
        const colName = colIndex !== undefined ? columnNames[parseInt(colIndex)] : 'Row #';
        const rowid = cell.closest('.spreadsheet-row')?.dataset.rowid || '';
        info.innerHTML = `<span class="selection-badge">${colName} (Row ${rowid})</span>`;
    } else {
        info.innerHTML = `<span class="selection-badge">${selectedCells.size} cells selected</span>`;
    }
}

// ============================================
// CELL EDITING
// ============================================

function editCell(cell) {
    if (!cell.classList.contains('data-cell')) return;
    if (isEditing) return;
    
    isEditing = true;
    cell.classList.add('editing');
    
    const content = cell.querySelector('.cell-content');
    const originalValue = cell.dataset.originalValue;
    const isNull = content.querySelector('.null-value') !== null;
    
    content.contentEditable = 'true';
    content.textContent = isNull ? '' : (content.textContent || '');
    content.focus();
    
    // Select all text
    const range = document.createRange();
    range.selectNodeContents(content);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    
    // Handle blur and keydown
    const handleBlur = () => {
        finishEditing(cell);
    };
    
    const handleKeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            finishEditing(cell);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEditing(cell);
        } else if (e.key === 'Tab') {
            e.preventDefault();
            finishEditing(cell);
            navigateToNextCell(cell, e.shiftKey ? -1 : 1);
        }
    };
    
    content.addEventListener('blur', handleBlur, { once: true });
    content.addEventListener('keydown', handleKeydown);
    
    // Store handlers for cleanup
    cell._editHandlers = { blur: handleBlur, keydown: handleKeydown };
}

function finishEditing(cell) {
    if (!isEditing) return;
    
    const content = cell.querySelector('.cell-content');
    const newValue = content.textContent.trim();
    const originalValue = cell.dataset.originalValue;
    
    content.contentEditable = 'false';
    cell.classList.remove('editing');
    isEditing = false;
    
    // Check if value changed
    const isChanged = newValue !== originalValue;
    
    if (isChanged) {
        markCellAsModified(cell, newValue);
    } else {
        // Restore original display
        if (originalValue === '') {
            content.innerHTML = '<span class="null-value">NULL</span>';
        }
        cell.classList.remove('modified');
        removeModification(cell);
    }
    
    // Show/hide empty placeholder
    if (newValue === '') {
        content.innerHTML = '<span class="null-value">NULL</span>';
    }
    
    updateToolbarState();
}

function cancelEditing(cell) {
    if (!isEditing) return;
    
    const content = cell.querySelector('.cell-content');
    const originalValue = cell.dataset.originalValue;
    
    content.contentEditable = 'false';
    cell.classList.remove('editing');
    isEditing = false;
    
    // Restore original value
    if (originalValue === '' || originalValue === undefined) {
        content.innerHTML = '<span class="null-value">NULL</span>';
    } else {
        content.textContent = originalValue;
    }
}

function navigateToNextCell(currentCell, direction) {
    const row = currentCell.closest('.spreadsheet-row');
    const cells = Array.from(row.querySelectorAll('.data-cell'));
    const currentIndex = cells.indexOf(currentCell);
    const nextIndex = currentIndex + direction;
    
    if (nextIndex >= 0 && nextIndex < cells.length) {
        selectCell(cells[nextIndex]);
        editCell(cells[nextIndex]);
    }
}

// Helper function to get column name from cell
function getColumnName(cell) {
    const colIndex = parseInt(cell.dataset.colIndex);
    return columnNames[colIndex];
}

// ============================================
// MODIFICATION TRACKING
// ============================================

function markCellAsModified(cell, newValue) {
    const row = cell.closest('.spreadsheet-row');
    const rowid = parseInt(row.dataset.rowid);
    const colName = getColumnName(cell);
    
    cell.classList.add('modified');
    
    // Track modification
    if (!modifiedRows.has(rowid)) {
        modifiedRows.set(rowid, {});
    }
    modifiedRows.get(rowid)[colName] = newValue;
    
    // Show row action buttons
    showRowActions(row);
    updateToolbarState();
}

function removeModification(cell) {
    const row = cell.closest('.spreadsheet-row');
    const rowid = parseInt(row.dataset.rowid);
    const colName = getColumnName(cell);
    
    if (modifiedRows.has(rowid)) {
        delete modifiedRows.get(rowid)[colName];
        if (Object.keys(modifiedRows.get(rowid)).length === 0) {
            modifiedRows.delete(rowid);
            hideRowActions(row);
        }
    }
    
    updateToolbarState();
}

function showRowActions(row) {
    const saveBtn = row.querySelector('.save-btn');
    const resetBtn = row.querySelector('.reset-btn');
    if (saveBtn) saveBtn.style.display = 'inline-flex';
    if (resetBtn) resetBtn.style.display = 'inline-flex';
    row.classList.add('row-modified');
}

function hideRowActions(row) {
    const saveBtn = row.querySelector('.save-btn');
    const resetBtn = row.querySelector('.reset-btn');
    if (saveBtn) saveBtn.style.display = 'none';
    if (resetBtn) resetBtn.style.display = 'none';
    row.classList.remove('row-modified');
}

function updateToolbarState() {
    const saveAllBtn = document.getElementById('save-all-btn');
    const discardAllBtn = document.getElementById('discard-all-btn');
    const modifiedCount = document.getElementById('modified-count');
    
    const hasModifications = modifiedRows.size > 0;
    
    saveAllBtn.disabled = !hasModifications;
    discardAllBtn.disabled = !hasModifications;
    
    if (hasModifications) {
        const totalChanges = Array.from(modifiedRows.values())
            .reduce((sum, row) => sum + Object.keys(row).length, 0);
        modifiedCount.textContent = `${modifiedRows.size} row${modifiedRows.size > 1 ? 's' : ''} modified (${totalChanges} change${totalChanges > 1 ? 's' : ''})`;
        modifiedCount.classList.add('has-changes');
    } else {
        modifiedCount.textContent = '';
        modifiedCount.classList.remove('has-changes');
    }
}

// ============================================
// SAVE & RESET OPERATIONS
// ============================================

async function saveRow(rowid) {
    if (!modifiedRows.has(rowid)) return;
    
    const row = document.querySelector(`.spreadsheet-row[data-rowid="${rowid}"]`);
    const data = modifiedRows.get(rowid);
    
    row.classList.add('saving');
    
    try {
        const response = await fetch(`/database/${dbName}/table/${tableName}/inline-update/${rowid}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update original values and remove modified state
            Object.entries(data).forEach(([colName, value]) => {
                // Find cell by column index
                const colIndex = columnNames.indexOf(colName);
                const cell = row.querySelector(`.data-cell[data-col-index="${colIndex}"]`);
                if (cell) {
                    cell.dataset.originalValue = value;
                    cell.classList.remove('modified');
                    cell.classList.add('saved');
                    setTimeout(() => cell.classList.remove('saved'), 1000);
                }
            });
            
            modifiedRows.delete(rowid);
            hideRowActions(row);
            updateToolbarState();
            showToast('Row saved successfully', 'success');
        } else {
            showToast(`Error: ${result.error}`, 'error');
        }
    } catch (error) {
        showToast(`Error saving row: ${error.message}`, 'error');
    } finally {
        row.classList.remove('saving');
    }
}

function resetRow(rowid) {
    const row = document.querySelector(`.spreadsheet-row[data-rowid="${rowid}"]`);
    
    // Reset all modified cells in this row
    row.querySelectorAll('.data-cell.modified').forEach(cell => {
        const content = cell.querySelector('.cell-content');
        const originalValue = cell.dataset.originalValue;
        
        if (originalValue === '' || originalValue === undefined) {
            content.innerHTML = '<span class="null-value">NULL</span>';
        } else {
            content.textContent = originalValue;
        }
        cell.classList.remove('modified');
    });
    
    modifiedRows.delete(rowid);
    hideRowActions(row);
    updateToolbarState();
}

async function saveAllChanges() {
    const rowids = Array.from(modifiedRows.keys());
    let successCount = 0;
    let errorCount = 0;
    
    for (const rowid of rowids) {
        try {
            await saveRow(rowid);
            successCount++;
        } catch (e) {
            errorCount++;
        }
    }
    
    if (errorCount === 0) {
        showToast(`All ${successCount} rows saved successfully`, 'success');
    } else {
        showToast(`Saved ${successCount} rows, ${errorCount} failed`, 'warning');
    }
}

function discardAllChanges() {
    if (!confirm('Discard all unsaved changes?')) return;
    
    const rowids = Array.from(modifiedRows.keys());
    rowids.forEach(rowid => resetRow(rowid));
    showToast('All changes discarded', 'info');
}

// ============================================
// ROW SELECTION
// ============================================

function toggleSelectAllRows(checkbox) {
    const isChecked = checkbox.checked;
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = isChecked;
        const row = cb.closest('.spreadsheet-row');
        if (isChecked) {
            row.classList.add('row-selected');
            selectedRows.add(parseInt(row.dataset.rowid));
        } else {
            row.classList.remove('row-selected');
            selectedRows.delete(parseInt(row.dataset.rowid));
        }
    });
}

function toggleRowSelection(checkbox, rowid) {
    const row = checkbox.closest('.spreadsheet-row');
    if (checkbox.checked) {
        row.classList.add('row-selected');
        selectedRows.add(rowid);
    } else {
        row.classList.remove('row-selected');
        selectedRows.delete(rowid);
    }
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.row-checkbox');
    const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
    const selectAllCheckbox = document.getElementById('select-all-rows');
    selectAllCheckbox.checked = checkedCount === allCheckboxes.length;
    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
}

// ============================================
// COLUMN RESIZING
// ============================================

function initColumnResize(e, colIndex) {
    e.preventDefault();
    e.stopPropagation();
    
    const headerCell = document.querySelector(`.header-cell[data-col="${colIndex}"]`);
    if (!headerCell) return;
    
    resizeState = {
        isResizing: true,
        startX: e.pageX,
        startWidth: headerCell.offsetWidth,
        colIndex: colIndex
    };
    
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    
    document.addEventListener('mousemove', doColumnResize);
    document.addEventListener('mouseup', stopColumnResize);
}

function doColumnResize(e) {
    if (!resizeState.isResizing) return;
    
    const newWidth = Math.max(80, resizeState.startWidth + (e.pageX - resizeState.startX));
    
    // Update header width
    const headerCell = document.querySelector(`.header-cell[data-col="${resizeState.colIndex}"]`);
    if (headerCell) {
        headerCell.style.width = newWidth + 'px';
        headerCell.style.minWidth = newWidth + 'px';
        headerCell.style.maxWidth = newWidth + 'px';
    }
    
    // Update all cells in this column
    document.querySelectorAll(`.spreadsheet-cell[data-col="${resizeState.colIndex}"]`).forEach(cell => {
        cell.style.width = newWidth + 'px';
        cell.style.minWidth = newWidth + 'px';
        cell.style.maxWidth = newWidth + 'px';
    });
    
    columnWidths[resizeState.colIndex] = newWidth;
}

function stopColumnResize() {
    resizeState.isResizing = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    document.removeEventListener('mousemove', doColumnResize);
    document.removeEventListener('mouseup', stopColumnResize);
    
    // Save column widths to localStorage
    localStorage.setItem(`spreadsheet_widths_${dbName}_${tableName}`, JSON.stringify(columnWidths));
}

function loadColumnWidths() {
    try {
        const saved = localStorage.getItem(`spreadsheet_widths_${dbName}_${tableName}`);
        if (saved) {
            columnWidths = JSON.parse(saved);
            Object.entries(columnWidths).forEach(([colIndex, width]) => {
                document.querySelectorAll(`.spreadsheet-cell[data-col="${colIndex}"]`).forEach(cell => {
                    cell.style.width = width + 'px';
                    cell.style.minWidth = width + 'px';
                    cell.style.maxWidth = width + 'px';
                });
            });
        }
    } catch (e) {
        console.warn('Failed to load column widths:', e);
    }
}

function initializeColumnWidths() {
    // Set initial widths based on header cell computed widths
    const headerCells = document.querySelectorAll('.header-cell[data-col]');
    headerCells.forEach(headerCell => {
        const colIndex = headerCell.getAttribute('data-col');
        // Skip special columns
        if (colIndex === '-1' || colIndex === '0' || colIndex === 'actions') return;
        
        // Only set if not already in columnWidths (from localStorage)
        if (!columnWidths[colIndex]) {
            const width = Math.max(120, headerCell.offsetWidth);
            columnWidths[colIndex] = width;
            
            // Apply to all cells in this column
            document.querySelectorAll(`.spreadsheet-cell[data-col="${colIndex}"]`).forEach(cell => {
                cell.style.width = width + 'px';
                cell.style.minWidth = width + 'px';
                cell.style.maxWidth = width + 'px';
            });
        }
    });
}

// ============================================
// KEYBOARD NAVIGATION
// ============================================

function handleKeyboardNavigation(e) {
    if (isEditing) return;
    if (!currentCell) return;
    
    const row = currentCell.closest('.spreadsheet-row');
    const cells = Array.from(row.querySelectorAll('.data-cell'));
    const currentIndex = cells.indexOf(currentCell);
    const rows = Array.from(document.querySelectorAll('.spreadsheet-row:not(.empty-row)'));
    const currentRowIndex = rows.indexOf(row);
    
    let nextCell = null;
    
    switch(e.key) {
        case 'ArrowRight':
            if (currentIndex < cells.length - 1) {
                nextCell = cells[currentIndex + 1];
            }
            break;
        case 'ArrowLeft':
            if (currentIndex > 0) {
                nextCell = cells[currentIndex - 1];
            }
            break;
        case 'ArrowDown':
            if (currentRowIndex < rows.length - 1) {
                const nextRow = rows[currentRowIndex + 1];
                nextCell = nextRow.querySelectorAll('.data-cell')[currentIndex];
            }
            break;
        case 'ArrowUp':
            if (currentRowIndex > 0) {
                const prevRow = rows[currentRowIndex - 1];
                nextCell = prevRow.querySelectorAll('.data-cell')[currentIndex];
            }
            break;
        case 'Enter':
            e.preventDefault();
            editCell(currentCell);
            return;
        case 'Delete':
        case 'Backspace':
            if (!isEditing) {
                e.preventDefault();
                editCell(currentCell);
                setTimeout(() => {
                    const content = currentCell.querySelector('.cell-content');
                    content.textContent = '';
                }, 0);
            }
            return;
    }
    
    if (nextCell) {
        e.preventDefault();
        clearSelection();
        selectCell(nextCell);
        nextCell.scrollIntoView({ block: 'nearest', inline: 'nearest' });
    }
}

// ============================================
// UNDO/REDO (Basic implementation)
// ============================================

let undoStack = [];
let redoStack = [];

function undoChanges() {
    // TODO: Implement undo
    showToast('Undo not yet implemented', 'info');
}

function redoChanges() {
    // TODO: Implement redo
    showToast('Redo not yet implemented', 'info');
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    // Load saved column widths
    loadColumnWidths();
    
    // Initialize column widths after a short delay to ensure layout is complete
    setTimeout(initializeColumnWidths, 50);
    
    // Keyboard navigation
    document.addEventListener('keydown', handleKeyboardNavigation);
    
    // Click outside to deselect
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.spreadsheet-cell') && !e.target.closest('.spreadsheet-toolbar')) {
            clearSelection();
        }
    });
    
    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (modifiedRows.size > 0) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
    
    // Add keyboard shortcut for query execution (Ctrl+Enter)
    const queryInput = document.getElementById('query-input');
    if (queryInput) {
        queryInput.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                executeQuery();
            }
        });
    }
    
    // Ctrl+S to save all changes
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            if (modifiedRows.size > 0) {
                saveAllChanges();
            }
        }
    });
});
</script>
{% endblock %}
