{% extends 'base.html' %}

{% block title %}{{ current_dashboard.name }} - SQLite Cult{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}
.dashboard-header-left {
    flex: 1;
    min-width: 200px;
}
.dashboard-header-right {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}
.dashboard-switcher {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.dashboard-switcher select {
    min-width: 180px;
}
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
}
@media (max-width: 500px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}
.chart-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}
.chart-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-surface-2);
}
.chart-card-title {
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.chart-card-title .chart-type-badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    background: var(--color-primary-light);
    color: var(--color-primary);
    border-radius: var(--border-radius-sm);
    font-weight: 500;
    text-transform: uppercase;
}
.chart-card-actions {
    display: flex;
    gap: 0.5rem;
}
.chart-card-body {
    padding: 1rem;
    height: 300px;
    position: relative;
}
.chart-error {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--color-danger);
    text-align: center;
    padding: 1rem;
    flex-direction: column;
    gap: 0.5rem;
}
.chart-error svg {
    opacity: 0.5;
}
.empty-dashboard {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--color-text-muted);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
}
.empty-dashboard svg {
    width: 64px;
    height: 64px;
    margin-bottom: 1rem;
    opacity: 0.5;
}
.dashboard-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}
.dashboard-info .default-badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.5rem;
    background: var(--color-primary);
    color: white;
    border-radius: 999px;
    font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="dashboard-header-left">
        <div class="dashboard-info">
            <h1 class="page-title">{{ current_dashboard.name }}</h1>
            {% if current_dashboard.is_default %}
            <span class="default-badge">Default</span>
            {% endif %}
        </div>
        <p class="page-subtitle">{{ current_dashboard.description|default:"Visualize your data with charts" }}</p>
    </div>
    <div class="dashboard-header-right">
        <div class="dashboard-switcher">
            <label style="font-size: 0.8rem; color: var(--color-text-muted);">Switch:</label>
            <select class="form-input" onchange="if(this.value) window.location.href=this.value">
                {% for dashboard in dashboards %}
                <option value="{% url 'dashboard_detail' dashboard.id %}" {% if dashboard.id == current_dashboard.id %}selected{% endif %}>
                    {{ dashboard.name }}{% if dashboard.is_default %} â˜…{% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        <a href="{% url 'dashboard_list' %}" class="btn btn-ghost" title="Manage Dashboards">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            All Dashboards
        </a>
        <a href="{% url 'create_chart' %}?dashboard={{ current_dashboard.id }}" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Chart
        </a>
    </div>
</div>

{% if charts %}
<div class="charts-grid">
    {% for chart in charts %}
    <div class="chart-card" data-chart-id="{{ chart.id }}">
        <div class="chart-card-header">
            <span class="chart-card-title">
                {{ chart.title }}
                <span class="chart-type-badge">{{ chart.get_chart_type_display }}</span>
            </span>
            <div class="chart-card-actions">
                <button class="btn-icon" onclick="refreshChart({{ chart.id }})" title="Refresh">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                </button>
                <a href="{% url 'edit_chart' chart.id %}" class="btn-icon" title="Edit">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </a>
                <form method="post" action="{% url 'delete_chart' chart.id %}" style="display: inline;" 
                      onsubmit="return confirm('Delete this chart?')">
                    {% csrf_token %}
                    <button type="submit" class="btn-icon" title="Delete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
        <div class="chart-card-body">
            <canvas id="chart-{{ chart.id }}"></canvas>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-dashboard">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="20" x2="18" y2="10"></line>
        <line x1="12" y1="20" x2="12" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="14"></line>
    </svg>
    <h2>No charts in this dashboard</h2>
    <p>Create your first chart to visualize data from your databases.</p>
    <a href="{% url 'create_chart' %}?dashboard={{ current_dashboard.id }}" class="btn btn-primary" style="margin-top: 1rem;">Create Chart</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
const chartInstances = {};
const chartColors = [
    'rgba(37, 99, 235, 0.8)',
    'rgba(22, 163, 74, 0.8)',
    'rgba(217, 119, 6, 0.8)',
    'rgba(220, 38, 38, 0.8)',
    'rgba(139, 92, 246, 0.8)',
    'rgba(6, 182, 212, 0.8)',
    'rgba(236, 72, 153, 0.8)',
    'rgba(245, 158, 11, 0.8)',
    'rgba(16, 185, 129, 0.8)',
    'rgba(99, 102, 241, 0.8)',
];

function getChartColors(count) {
    const colors = [];
    for (let i = 0; i < count; i++) {
        colors.push(chartColors[i % chartColors.length]);
    }
    return colors;
}

function renderChart(chartId, chartType, columns, data) {
    const canvas = document.getElementById('chart-' + chartId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart if any
    if (chartInstances[chartId]) {
        chartInstances[chartId].destroy();
    }
    
    if (!data || data.length === 0 || columns.length < 2) {
        canvas.parentElement.innerHTML = `
            <div class="chart-error">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span>No data or insufficient columns.<br>Query must return at least 2 columns.</span>
            </div>`;
        return;
    }
    
    // First column is labels, rest are values
    const labels = data.map(row => row[columns[0]]);
    const datasets = [];
    
    if (chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea') {
        // For pie/doughnut/polarArea, use second column as values
        datasets.push({
            data: data.map(row => parseFloat(row[columns[1]]) || 0),
            backgroundColor: getChartColors(data.length),
            borderWidth: 1
        });
    } else if (chartType === 'radar') {
        // For radar, each value column becomes a dataset
        for (let i = 1; i < columns.length; i++) {
            datasets.push({
                label: columns[i],
                data: data.map(row => parseFloat(row[columns[i]]) || 0),
                backgroundColor: chartColors[(i - 1) % chartColors.length].replace('0.8', '0.2'),
                borderColor: chartColors[(i - 1) % chartColors.length],
                borderWidth: 2,
                pointBackgroundColor: chartColors[(i - 1) % chartColors.length],
            });
        }
    } else {
        // For bar/line, each value column becomes a dataset
        for (let i = 1; i < columns.length; i++) {
            datasets.push({
                label: columns[i],
                data: data.map(row => parseFloat(row[columns[i]]) || 0),
                backgroundColor: chartColors[(i - 1) % chartColors.length],
                borderColor: chartColors[(i - 1) % chartColors.length],
                borderWidth: 2,
                tension: 0.1
            });
        }
    }
    
    chartInstances[chartId] = new Chart(ctx, {
        type: chartType,
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea' || chartType === 'radar' || columns.length > 2
                }
            }
        }
    });
}

function refreshChart(chartId) {
    fetch(`/dashboard/chart/${chartId}/data/`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                renderChart(chartId, data.chart_type, data.columns, data.data);
            } else {
                const canvas = document.getElementById('chart-' + chartId);
                if (canvas) {
                    canvas.parentElement.innerHTML = `
                        <div class="chart-error">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <span>${data.error}</span>
                        </div>`;
                }
            }
        })
        .catch(err => console.error('Error refreshing chart:', err));
}

// Load all charts on page load
document.addEventListener('DOMContentLoaded', function() {
    {% for chart in charts %}
    refreshChart({{ chart.id }});
    {% endfor %}
});
</script>
{% endblock %}
